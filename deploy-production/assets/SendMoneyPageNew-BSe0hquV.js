import{r as e,j as t,u as a,P as n,c as s,a as r,b as o,d as l,e as i,f as c,g as u,h as d,i as m,I as f,L as p,C as v,k as x,s as b,l as h,D as w,m as g,R as y,A as j,n as N,W as S,o as _,B as R,p as T,q as C}from"./index-BEextJzm.js";var I="rovingFocusGroup.onEntryFocus",F={bubbles:!1,cancelable:!0},E="RovingFocusGroup",[D,A,M]=o(E),[K,P]=r(E,[M]),[k,L]=K(E),W=e.forwardRef((e,a)=>t.jsx(D.Provider,{scope:e.__scopeRovingFocusGroup,children:t.jsx(D.Slot,{scope:e.__scopeRovingFocusGroup,children:t.jsx($,{...e,ref:a})})}));W.displayName=E;var $=e.forwardRef((a,r)=>{const{__scopeRovingFocusGroup:o,orientation:d,loop:m=!1,dir:f,currentTabStopId:p,defaultCurrentTabStopId:v,onCurrentTabStopIdChange:x,onEntryFocus:b,preventScrollOnEntryFocus:h=!1,...w}=a,g=e.useRef(null),y=l(r,g),j=i(f),[N,S]=c({prop:p,defaultProp:v??null,onChange:x,caller:E}),[_,R]=e.useState(!1),T=u(b),C=A(o),D=e.useRef(!1),[M,K]=e.useState(0);return e.useEffect(()=>{const e=g.current;if(e)return e.addEventListener(I,T),()=>e.removeEventListener(I,T)},[T]),t.jsx(k,{scope:o,orientation:d,dir:j,loop:m,currentTabStopId:N,onItemFocus:e.useCallback(e=>S(e),[S]),onItemShiftTab:e.useCallback(()=>R(!0),[]),onFocusableItemAdd:e.useCallback(()=>K(e=>e+1),[]),onFocusableItemRemove:e.useCallback(()=>K(e=>e-1),[]),children:t.jsx(n.div,{tabIndex:_||0===M?-1:0,"data-orientation":d,...w,ref:y,style:{outline:"none",...a.style},onMouseDown:s(a.onMouseDown,()=>{D.current=!0}),onFocus:s(a.onFocus,e=>{const t=!D.current;if(e.target===e.currentTarget&&t&&!_){const t=new CustomEvent(I,F);if(e.currentTarget.dispatchEvent(t),!t.defaultPrevented){const e=C().filter(e=>e.focusable);G([e.find(e=>e.active),e.find(e=>e.id===N),...e].filter(Boolean).map(e=>e.ref.current),h)}}D.current=!1}),onBlur:s(a.onBlur,()=>R(!1))})})}),X="RovingFocusGroupItem",V=e.forwardRef((r,o)=>{const{__scopeRovingFocusGroup:l,focusable:i=!0,active:c=!1,tabStopId:u,children:d,...m}=r,f=a(),p=u||f,v=L(X,l),x=v.currentTabStopId===p,b=A(l),{onFocusableItemAdd:h,onFocusableItemRemove:w,currentTabStopId:g}=v;return e.useEffect(()=>{if(i)return h(),()=>w()},[i,h,w]),t.jsx(D.ItemSlot,{scope:l,id:p,focusable:i,active:c,children:t.jsx(n.span,{tabIndex:x?0:-1,"data-orientation":v.orientation,...m,ref:o,onMouseDown:s(r.onMouseDown,e=>{i?v.onItemFocus(p):e.preventDefault()}),onFocus:s(r.onFocus,()=>v.onItemFocus(p)),onKeyDown:s(r.onKeyDown,e=>{if("Tab"===e.key&&e.shiftKey)return void v.onItemShiftTab();if(e.target!==e.currentTarget)return;const t=function(e,t,a){const n=function(e,t){return"rtl"!==t?e:"ArrowLeft"===e?"ArrowRight":"ArrowRight"===e?"ArrowLeft":e}(e.key,a);return"vertical"===t&&["ArrowLeft","ArrowRight"].includes(n)||"horizontal"===t&&["ArrowUp","ArrowDown"].includes(n)?void 0:B[n]}(e,v.orientation,v.dir);if(void 0!==t){if(e.metaKey||e.ctrlKey||e.altKey||e.shiftKey)return;e.preventDefault();let s=b().filter(e=>e.focusable).map(e=>e.ref.current);if("last"===t)s.reverse();else if("prev"===t||"next"===t){"prev"===t&&s.reverse();const r=s.indexOf(e.currentTarget);s=v.loop?(n=r+1,(a=s).map((e,t)=>a[(n+t)%a.length])):s.slice(r+1)}setTimeout(()=>G(s))}var a,n}),children:"function"==typeof d?d({isCurrentTabStop:x,hasTabStop:null!=g}):d})})});V.displayName=X;var B={ArrowLeft:"prev",ArrowUp:"prev",ArrowRight:"next",ArrowDown:"next",PageUp:"first",Home:"first",PageDown:"last",End:"last"};function G(e,t=!1){const a=document.activeElement;for(const n of e){if(n===a)return;if(n.focus({preventScroll:t}),document.activeElement!==a)return}}var U=W,q=V,z="Tabs",[O]=r(z,[P]),H=P(),[J,Q]=O(z),Y=e.forwardRef((e,s)=>{const{__scopeTabs:r,value:o,onValueChange:l,defaultValue:u,orientation:d="horizontal",dir:m,activationMode:f="automatic",...p}=e,v=i(m),[x,b]=c({prop:o,onChange:l,defaultProp:u??"",caller:z});return t.jsx(J,{scope:r,baseId:a(),value:x,onValueChange:b,orientation:d,dir:v,activationMode:f,children:t.jsx(n.div,{dir:v,"data-orientation":d,...p,ref:s})})});Y.displayName=z;var Z="TabsList",ee=e.forwardRef((e,a)=>{const{__scopeTabs:s,loop:r=!0,...o}=e,l=Q(Z,s),i=H(s);return t.jsx(U,{asChild:!0,...i,orientation:l.orientation,dir:l.dir,loop:r,children:t.jsx(n.div,{role:"tablist","aria-orientation":l.orientation,...o,ref:a})})});ee.displayName=Z;var te="TabsTrigger",ae=e.forwardRef((e,a)=>{const{__scopeTabs:r,value:o,disabled:l=!1,...i}=e,c=Q(te,r),u=H(r),d=re(c.baseId,o),m=oe(c.baseId,o),f=o===c.value;return t.jsx(q,{asChild:!0,...u,focusable:!l,active:f,children:t.jsx(n.button,{type:"button",role:"tab","aria-selected":f,"aria-controls":m,"data-state":f?"active":"inactive","data-disabled":l?"":void 0,disabled:l,id:d,...i,ref:a,onMouseDown:s(e.onMouseDown,e=>{l||0!==e.button||!1!==e.ctrlKey?e.preventDefault():c.onValueChange(o)}),onKeyDown:s(e.onKeyDown,e=>{[" ","Enter"].includes(e.key)&&c.onValueChange(o)}),onFocus:s(e.onFocus,()=>{const e="manual"!==c.activationMode;f||l||!e||c.onValueChange(o)})})})});ae.displayName=te;var ne="TabsContent",se=e.forwardRef((a,s)=>{const{__scopeTabs:r,value:o,forceMount:l,children:i,...c}=a,u=Q(ne,r),m=re(u.baseId,o),f=oe(u.baseId,o),p=o===u.value,v=e.useRef(p);return e.useEffect(()=>{const e=requestAnimationFrame(()=>v.current=!1);return()=>cancelAnimationFrame(e)},[]),t.jsx(d,{present:l||p,children:({present:e})=>t.jsx(n.div,{"data-state":p?"active":"inactive","data-orientation":u.orientation,role:"tabpanel","aria-labelledby":m,hidden:!e,id:f,tabIndex:0,...c,ref:s,style:{...a.style,animationDuration:v.current?"0s":void 0},children:e&&i})})});function re(e,t){return`${e}-trigger-${t}`}function oe(e,t){return`${e}-content-${t}`}se.displayName=ne;var le=ee,ie=ae,ce=se;const ue=Y,de=e.forwardRef(({className:e,...a},n)=>t.jsx(le,{ref:n,className:m("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",e),...a}));de.displayName=le.displayName;const me=e.forwardRef(({className:e,...a},n)=>t.jsx(ie,{ref:n,className:m("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",e),...a}));me.displayName=ie.displayName;const fe=e.forwardRef(({className:e,...a},n)=>t.jsx(ce,{ref:n,className:m("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",e),...a}));fe.displayName=ce.displayName;const pe=({value:a,onChange:n,onValidation:s,label:r="Wallet Number",placeholder:o="Enter wallet number",disabled:l=!1,isAgentWallet:i=!1})=>{const[c,u]=e.useState(!1),[d,m]=e.useState(null);return e.useEffect(()=>{if(!a||a.length<3)return m(null),void s(!1);const e=setTimeout(async()=>{u(!0);try{const{data:e,error:t}=await b.from("wallets").select("\n            id,\n            wallet_id,\n            user_id,\n            profiles!inner(full_name, phone)\n          ").eq("wallet_id",a).maybeSingle();if(t||!e)m({valid:!1}),s(!1);else{const t=e.profiles;m({valid:!0,name:t?.full_name||"Unknown",walletId:e.wallet_id}),s(!0,t?.full_name,e.wallet_id)}}catch(e){m({valid:!1}),s(!1)}u(!1)},500);return()=>clearTimeout(e)},[a,i,s]),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-foreground",children:r}),t.jsxs("div",{className:"relative mt-1",children:[t.jsx(f,{type:"text",placeholder:o,value:a,onChange:e=>n(e.target.value.toUpperCase()),className:"pr-10",disabled:l}),t.jsxs("div",{className:"absolute right-3 top-1/2 -translate-y-1/2",children:[c&&t.jsx(p,{className:"w-4 h-4 animate-spin text-muted-foreground"}),!c&&d?.valid&&t.jsx(v,{className:"w-4 h-4 text-success"}),!c&&d&&!d.valid&&a.length>=3&&t.jsx(x,{className:"w-4 h-4 text-destructive"})]})]}),d?.valid&&d.name&&t.jsxs("p",{className:"text-sm text-success mt-1",children:["✓ ",d.name]}),d&&!d.valid&&a.length>=3&&t.jsx("p",{className:"text-sm text-destructive mt-1",children:"✗ Wallet not found"})]})},ve=()=>{const[a,n]=e.useState("form"),[s,r]=e.useState("wallet"),[o,l]=e.useState(""),[i,c]=e.useState(!1),[u,d]=e.useState(""),[m,p]=e.useState(""),[v,x]=e.useState(""),[I,F]=e.useState(""),[E,D]=e.useState(""),[A,M]=e.useState(!1),[K,P]=e.useState({wallet:0,phone:0}),{wallet:k,refetch:L}=h();e.useEffect(()=>{(async()=>{const{data:e}=await b.from("fees").select("*").in("transaction_type",["send_money_wallet","send_money_phone"]);if(e){const t=e.find(e=>"send_money_wallet"===e.transaction_type),a=e.find(e=>"send_money_phone"===e.transaction_type);P({wallet:t?Number(t.flat_fee):0,phone:a?Number(a.flat_fee):15})}})()},[]);const W=(()=>{const e=Number(v);return"wallet"===s?Math.min(Math.max(.005*e,5),50):Math.min(Math.max(15+.01*e,15),100)})(),$=Number(v)+W,X=async e=>{M(!0),F(e);try{const{data:t}=await b.from("wallets").select("balance").eq("id",k?.id).single();if(!t||t.balance<$)return T.error("Insufficient funds"),M(!1),void n("form");if("wallet"===s){const t=await C.sendMoney({recipientWalletNumber:o,amount:Number(v),description:`Transfer to ${u}`,pin:e});t.success?(D(t.receiptReference||t.transactionId||""),T.success(t.message),await L(),n("receipt")):(T.error(t.message),n("form"))}else{const e="TXN-"+Date.now().toString(36).toUpperCase();D(e);const{error:a}=await b.from("wallets").update({balance:t.balance-$}).eq("id",k?.id);if(a)return T.error("Transfer failed"),M(!1),void n("form");await b.from("transactions").insert({sender_wallet_id:k?.id,type:"send_money_phone",amount:Number(v),fee:W,status:"completed",transaction_id:e,metadata:{phone:m,recipient_type:"phone"}}),T.success("Transfer sent successfully!"),await L(),n("receipt")}}catch(t){T.error(t.message||"Transfer failed"),n("form")}M(!1)},V=()=>{n("form"),l(""),p(""),x(""),F(""),d("")};if("pin"===a)return t.jsx(w,{role:"user",children:t.jsx("div",{className:"max-w-md mx-auto",children:t.jsx(g,{onSubmit:X,onCancel:()=>n("confirm")})})});if("receipt"===a)return t.jsx(w,{role:"user",children:t.jsx("div",{className:"max-w-md mx-auto",children:t.jsx(y,{title:"Money Sent Successfully",message:`ABANREMIT: Confirmed. KES ${v}.00 sent to ${"wallet"===s?o:m}. Wallet ${k?.wallet_id||"—"}. Ref ${E}.`,items:[{label:"Transaction ID",value:E},{label:"wallet"===s?"Recipient Wallet":"Recipient Phone",value:"wallet"===s?o:m},..."wallet"===s&&u?[{label:"Recipient Name",value:u}]:[],{label:"Amount",value:`KES ${v}.00`},{label:"Fee",value:`KES ${W.toFixed(2)}`},{label:"New Balance",value:`KES ${((k?.balance??0)-$).toLocaleString(void 0,{minimumFractionDigits:2})}`},{label:"Date",value:(new Date).toLocaleString()}],onDone:V})})});if("confirm"===a)return t.jsx(w,{role:"user",children:t.jsx("div",{className:"max-w-md mx-auto",children:t.jsx(j,{title:"Confirm Send Money "+("wallet"===s?"to Wallet":"to Phone"),details:[{label:"wallet"===s?"Recipient Wallet":"Recipient Phone",value:"wallet"===s?o:m},..."wallet"===s&&u?[{label:"Recipient Name",value:u}]:[]],amount:v,fee:W.toFixed(2),onConfirm:()=>n("pin"),onCancel:()=>n("form")})})});const B=v&&("wallet"===s&&i||"phone"===s&&m)&&k&&k.balance>=$;return t.jsx(w,{role:"user",children:t.jsxs("div",{className:"max-w-md mx-auto space-y-6",children:[t.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"Send Money"}),t.jsxs(N,{className:"p-6 space-y-4",children:[t.jsxs(ue,{value:s,onValueChange:e=>r(e),children:[t.jsxs(de,{className:"grid w-full grid-cols-2",children:[t.jsxs(me,{value:"wallet",className:"flex items-center gap-2",children:[t.jsx(S,{className:"w-4 h-4"}),"To Wallet"]}),t.jsxs(me,{value:"phone",className:"flex items-center gap-2",children:[t.jsx(_,{className:"w-4 h-4"}),"To Phone"]})]}),t.jsx(fe,{value:"wallet",className:"space-y-4 mt-4",children:t.jsx(pe,{value:o,onChange:l,onValidation:(e,t)=>{c(e),d(t||"")},label:"Recipient Wallet Number",placeholder:"Enter wallet number (e.g., WLT001)",disabled:A})}),t.jsx(fe,{value:"phone",className:"space-y-4 mt-4",children:t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-foreground",children:"Recipient Phone Number"}),t.jsx(f,{type:"tel",placeholder:"254XXXXXXXXX",value:m,onChange:e=>p(e.target.value),className:"mt-1",disabled:A}),t.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Money will be sent via M-Pesa"})]})})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-foreground",children:"Amount (KES)"}),t.jsx(f,{type:"number",placeholder:"Enter amount",value:v,onChange:e=>x(e.target.value),className:"mt-1",disabled:A})]}),v&&t.jsxs("div",{className:"text-sm text-muted-foreground",children:["Fee: ",t.jsxs("span",{className:"text-destructive",children:["KES ",W.toFixed(2)]}),t.jsxs("span",{className:"text-xs ml-2",children:["(","wallet"===s?"0.5% wallet transfer":"M-Pesa transfer",")"]})]}),v&&k&&t.jsxs("div",{className:"text-sm",children:[t.jsx("span",{className:"text-muted-foreground",children:"Available Balance: "}),t.jsxs("span",{className:"font-medium "+(k.balance<$?"text-destructive":"text-success"),children:["KES ",k.balance.toLocaleString(void 0,{minimumFractionDigits:2})]})]}),v&&k&&k.balance<$&&t.jsx("div",{className:"text-sm text-destructive font-medium",children:"⚠️ Insufficient funds"}),t.jsx(R,{onClick:()=>n("confirm"),disabled:!B||A,className:"w-full",children:A?"Processing...":"Continue"})]})]})})};export{ve as default};
